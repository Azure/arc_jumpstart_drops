name: Build Drops JSON

on:
  [push, pull_request, fork]

permissions:
  contents: write

jobs:
  build-drops:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Create autogenerated directory
      run: |
        mkdir -p autogenerated
        echo "Created autogenerated directory"

    - name: Build drops JSON file
      run: |
        echo "Building drops JSON from drops folder..."
        
        # Initialize the JSON array
        echo "[" > autogenerated/drops.json
        
        # Process each JSON file in the drops folder
        first_file=true
        for file in drops/*.json; do
          if [ -f "$file" ]; then
            if [ "$first_file" = true ]; then
              first_file=false
            else
              echo "," >> autogenerated/drops.json
            fi
            
            # Add the content of each JSON file to the array
            cat "$file" >> autogenerated/drops.json
          fi
        done
        
        # Close the JSON array
        echo "]" >> autogenerated/drops.json
        
        echo "✅ Successfully created autogenerated/drops.json"

    - name: Validate generated JSON
      run: |
        if jq empty autogenerated/drops.json; then
          echo "✅ Generated JSON is valid"
        else
          echo "❌ Generated JSON is invalid"
          exit 1
        fi

    - name: Display file info
      run: |
        echo "Generated file: autogenerated/drops.json"
        echo "File size: $(wc -c < autogenerated/drops.json) bytes"
        echo "Number of drops: $(jq length autogenerated/drops.json)"

    - name: Commit and push changes
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/canary')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain autogenerated/)" ]; then
          git add autogenerated/
          git commit -m "Auto-update drops.json from drops folder [skip ci]"
          git push
          echo "✅ Changes committed and pushed"
        else
          echo "No changes to commit"
        fi
