name: Build Drops JSON

on:
  push:
    paths:
      - 'drops/**'
      - '.github/workflows/build-drops-json.yaml'
  pull_request:
    paths:
      - 'drops/**'
      - '.github/workflows/build-drops-json.yaml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-drops:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup jq for JSON processing
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Create autogenerated directory
      run: |
        mkdir -p autogenerated
        echo "✅ Created autogenerated directory"

    - name: Build comprehensive drops JSON
      run: |
        echo "🔄 Building comprehensive drops.json from all files in drops folder..."
        
        # Initialize empty JSON array
        echo "[]" > autogenerated/drops.json
        
        # Counter for tracking files
        file_count=0
        
        # Process each JSON file in the drops folder
        for file in drops/*.json; do
          if [ -f "$file" ]; then
            echo "Processing: $(basename "$file")"
            
            # Validate individual JSON file first
            if ! jq empty "$file" 2>/dev/null; then
              echo "⚠️  Warning: $file contains invalid JSON, skipping..."
              continue
            fi
            
            # Add the JSON content to the array using jq
            temp_file=$(mktemp)
            jq --argjson newItem "$(cat "$file")" '. += [$newItem]' autogenerated/drops.json > "$temp_file"
            mv "$temp_file" autogenerated/drops.json
            
            ((file_count++))
          fi
        done
        
        echo "✅ Successfully processed $file_count JSON files into autogenerated/drops.json"

    - name: Validate final JSON structure
      run: |
        echo "🔍 Validating final JSON structure..."
        
        if jq empty autogenerated/drops.json; then
          echo "✅ Generated JSON is syntactically valid"
        else
          echo "❌ Generated JSON is invalid"
          exit 1
        fi
        
        # Additional validation - check if it's an array
        if jq -e 'type == "array"' autogenerated/drops.json >/dev/null; then
          echo "✅ JSON is properly formatted as an array"
        else
          echo "❌ JSON is not formatted as an array"
          exit 1
        fi

    - name: Display comprehensive file info
      run: |
        echo "📊 File Statistics:"
        echo "==================="
        echo "Generated file: autogenerated/drops.json"
        echo "File size: $(wc -c < autogenerated/drops.json | numfmt --to=iec-i --suffix=B)"
        echo "Number of drops: $(jq length autogenerated/drops.json)"
        echo "Files in drops folder: $(find drops -name "*.json" -type f | wc -l)"
        echo ""
        echo "📋 Sample of included drops:"
        jq -r '.[0:3] | .[] | "- " + (.Title // .title // "Untitled")' autogenerated/drops.json || echo "No drops found"

    - name: Check for changes and commit
      if: github.event_name == 'push'
      run: |
        echo "🔍 Checking for changes in autogenerated folder..."
        
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Check if there are changes
        if [ -n "$(git status --porcelain autogenerated/)" ]; then
          echo "📝 Changes detected in autogenerated/drops.json"
          
          # Add and commit the changes
          git add autogenerated/drops.json
          git commit -m "🤖 Auto-update drops.json from drops folder
          
          - Updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Drops count: $(jq length autogenerated/drops.json)
          - Triggered by: ${{ github.event.head_commit.message || 'Manual trigger' }}
          
          [skip ci]"
          
          # Push the changes
          git push
          echo "✅ Successfully committed and pushed updated drops.json"
        else
          echo "ℹ️  No changes detected in autogenerated/drops.json"
        fi

    - name: Summary
      run: |
        echo ""
        echo "🎉 Workflow Summary"
        echo "===================="
        echo "✅ Successfully built autogenerated/drops.json"
        echo "📁 Source: drops/ folder"
        echo "📄 Output: autogenerated/drops.json"
        echo "📊 Total drops: $(jq length autogenerated/drops.json)"
        echo "🔄 Trigger: ${{ github.event_name }}"
